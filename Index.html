<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>El Poblado - Sistema de Ventas</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap');
        
        * {
            font-family: 'Inter', sans-serif;
        }
        
        .tab-button.active {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            box-shadow: 0 4px 15px rgba(102, 126, 234, 0.25);
        }
        
        .product-card {
            transition: all 0.3s ease;
            background: linear-gradient(135deg, #f5f7fa 0%, #c3cfe2 100%);
        }
        
        .product-card:hover {
            transform: translateY(-2px);
            box-shadow: 0 8px 25px rgba(0,0,0,0.1);
        }
        
        .category-badge {
            background: linear-gradient(45deg, #667eea, #764ba2);
        }
        
        .stats-card {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
        }
        
        .input-field {
            transition: all 0.3s ease;
        }
        
        .input-field:focus {
            transform: translateY(-1px);
            box-shadow: 0 4px 12px rgba(102, 126, 234, 0.2);
        }
        
        .btn-primary {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            transition: all 0.3s ease;
        }
        
        .btn-primary:hover {
            transform: translateY(-1px);
            box-shadow: 0 6px 20px rgba(102, 126, 234, 0.3);
        }
        
        .btn-danger {
            background: linear-gradient(135deg, #ff6b6b 0%, #ee5a52 100%);
            transition: all 0.3s ease;
        }
        
        .btn-danger:hover {
            transform: translateY(-1px);
            box-shadow: 0 6px 20px rgba(255, 107, 107, 0.3);
        }
        
        .cart-item {
            background: linear-gradient(135deg, #ffecd2 0%, #fcb69f 100%);
            border-left: 4px solid #667eea;
        }
        
        .hero-section {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            position: relative;
            overflow: hidden;
        }
        
        .hero-section::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: url('data:image/svg+xml,<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 100 100"><defs><pattern id="grid" width="10" height="10" patternUnits="userSpaceOnUse"><path d="M 10 0 L 0 0 0 10" fill="none" stroke="rgba(255,255,255,0.1)" stroke-width="0.5"/></pattern></defs><rect width="100" height="100" fill="url(%23grid)"/></svg>');
            opacity: 0.3;
        }
        
        .animate-float {
            animation: float 3s ease-in-out infinite;
        }
        
        @keyframes float {
            0%, 100% { transform: translateY(0px); }
            50% { transform: translateY(-10px); }
        }
        
        .chart-bar {
            transition: all 0.3s ease;
        }
        
        .chart-bar:hover {
            opacity: 0.8;
            transform: scaleY(1.05);
        }

        /* --- Estilos para la tabla de inventario --- */
        #inventoryTable td:nth-child(1), #inventoryTable th:nth-child(1) {
            /* Primera columna (Producto) */
            width: 35%; /* Dale un porcentaje más grande de ancho */
            min-width: 150px; /* Asegura un ancho mínimo para nombres largos */
            white-space: normal; /* Permite que el texto se ajuste a múltiples líneas */
        }
        #inventoryTable td, #inventoryTable th {
            /* Estilo general para celdas de la tabla */
            white-space: nowrap; /* Evita que el texto se envuelva en otras columnas por defecto */
            overflow: hidden; /* Oculta el texto que desborda */
            text-overflow: ellipsis; /* Añade puntos suspensivos si el texto se corta */
        }
        #inventoryTable td:nth-child(1) {
            white-space: normal; /* Sobrescribe para la primera columna para permitir el salto de línea */
        }
        /* Asegura que los input dentro de las celdas de la tabla también se ajusten */
        #inventoryTable td input {
            width: 100%;
            box-sizing: border-box; /* Incluye padding y border en el ancho */
        }
        /* --- Fin de estilos para la tabla de inventario --- */
    </style>
</head>
<body class="bg-gray-100 min-h-screen">
    <div class="hero-section text-white py-16 relative">
        <div class="container mx-auto px-4 text-center relative z-10">
            <div class="flex justify-center mb-6">
                <img src="https://storage.googleapis.com/workspace-0f70711f-8b4e-4d94-86f1-2a93ccde5887/image/621a1090-46aa-48b0-83f0-6f5fefb9a58d.png" alt="El Poblado store logo featuring a modern shopping cart icon with mountain silhouette in the background, rendered in elegant gold and white colors" class="animate-float" />
            </div>
            <h1 class="text-5xl font-bold mb-4">El Poblado</h1>
            <p class="text-xl opacity-90">Sistema Integral de Ventas e Inventario</p>
        </div>
    </div>

    <div class="bg-white shadow-lg sticky top-0 z-50">
        <div class="container mx-auto px-4">
            <div class="flex flex-wrap justify-center gap-2 py-4">
                <button onclick="window.showTab('ventas')" class="tab-button px-6 py-3 rounded-lg font-medium bg-gray-200 hover:bg-gray-300 transition-all">
                    Ventas
                </button>
                <button onclick="window.showTab('inventario')" class="tab-button px-6 py-3 rounded-lg font-medium bg-gray-200 hover:bg-gray-300 transition-all">
                    Inventario
                </button>
                <button onclick="window.showTab('resumen')" class="tab-button px-6 py-3 rounded-lg font-medium bg-gray-200 hover:bg-gray-300 transition-all">
                    Resumen
                </button>
            </div>
        </div>
    </div>

    <div class="container mx-auto px-4 py-8">
        <div id="ventas-tab" class="tab-content">
            <div class="grid grid-cols-1 lg:grid-cols-3 gap-8">
                <div class="lg:col-span-2">
                    <div class="bg-white rounded-xl shadow-lg p-6">
                        <h2 class="text-2xl font-bold mb-6 text-gray-800">Productos Disponibles</h2>
                        
                        <div class="mb-6">
                            <select id="categoryFilter" class="input-field w-full px-4 py-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent">
                                <option value="">Todas las categorías</option>
                            </select>
                        </div>
                        
                        <div id="productList" class="grid grid-cols-1 sm:grid-cols-2 gap-4"></div>
                    </div>
                </div>
                
                <div>
                    <div class="bg-white rounded-xl shadow-lg p-6">
                        <h2 class="text-2xl font-bold mb-6 text-gray-800">Carrito de Compras</h2>
                        
                        <div id="cart" class="space-y-3 mb-6"></div>
                        
                        <div class="border-t pt-4">
                            <div class="text-xl font-bold mb-4">
                                Total: $<span id="totalAmount">0</span>
                            </div>
                            
                            <div class="space-y-4">
                                <div>
                                    <label class="block text-sm font-medium mb-2">Dinero recibido:</label>
                                    <input type="number" id="receivedAmount" class="input-field w-full px-4 py-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent" placeholder="0" step="0.01">
                                </div>
                                
                                <div class="text-lg font-semibold">
                                    Cambio: $<span id="changeAmount">0</span>
                                </div>
                                
                                <button onclick="window.processSale()" class="btn-primary w-full py-3 text-white font-semibold rounded-lg">
                                    Procesar Venta
                                </button>
                                
                                <button onclick="window.clearCart()" class="w-full py-3 bg-gray-500 text-white font-semibold rounded-lg hover:bg-gray-600 transition-all">
                                    Limpiar Carrito
                                </button>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <div id="inventario-tab" class="tab-content hidden">
            <div class="bg-white rounded-xl shadow-lg p-6">
                <div class="flex flex-col sm:flex-row justify-between items-start sm:items-center mb-6 gap-4">
                    <h2 class="text-2xl font-bold text-gray-800">Gestión de Inventario</h2>
                    <button onclick="window.showAddProductForm()" class="btn-primary px-6 py-3 text-white font-semibold rounded-lg">
                        Agregar Producto
                    </button>
                </div>
                
                <div id="addProductForm" class="hidden bg-gray-50 rounded-lg p-6 mb-6">
                    <h3 class="text-lg font-semibold mb-4">Agregar Nuevo Producto</h3>
                    <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-4">
                        <input type="text" id="newProductName" placeholder="Nombre del producto" class="input-field px-4 py-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent">
                        <input type="number" id="newProductPrice" placeholder="Precio" step="0.01" class="input-field px-4 py-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent">
                        <input type="number" id="newProductStock" placeholder="Stock inicial" class="input-field px-4 py-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent">
                        <input type="text" id="newProductCategory" placeholder="Categoría" class="input-field px-4 py-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent">
                        <input type="number" id="newProductCost" placeholder="Costo (opcional)" step="0.01" class="input-field px-4 py-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent">
                    </div>
                    <div class="flex gap-4 mt-4">
                        <button onclick="window.addProduct()" class="btn-primary px-6 py-3 text-white font-semibold rounded-lg">
                            Agregar
                        </button>
                        <button onclick="window.hideAddProductForm()" class="px-6 py-3 bg-gray-500 text-white font-semibold rounded-lg hover:bg-gray-600 transition-all">
                            Cancelar
                        </button>
                    </div>
                </div>
                
                <div class="overflow-x-auto">
                    <table class="w-full border-collapse">
                        <thead>
                            <tr class="bg-gray-50">
                                <th class="border border-gray-200 px-4 py-3 text-left font-semibold">Producto</th>
                                <th class="border border-gray-200 px-4 py-3 text-left font-semibold">Precio</th>
                                <th class="border border-gray-200 px-4 py-3 text-left font-semibold">Stock</th>
                                <th class="border border-gray-200 px-4 py-3 text-left font-semibold">Categoría</th>
                                <th class="border border-gray-200 px-4 py-3 text-left font-semibold">Costo</th>
                                <th class="border border-gray-200 px-4 py-3 text-left font-semibold">Acciones</th>
                            </tr>
                        </thead>
                        <tbody id="inventoryTable"></tbody>
                    </table>
                </div>
            </div>
        </div>

        <div id="resumen-tab" class="tab-content hidden">
            <div class="grid grid-cols-1 lg:grid-cols-2 gap-8">
                <div class="space-y-6">
                    <div class="bg-white rounded-xl shadow-lg p-6">
                        <h2 class="text-2xl font-bold mb-6 text-gray-800">Estadísticas Generales</h2>
                        
                        <div class="grid grid-cols-1 sm:grid-cols-2 gap-4">
                            <div class="stats-card rounded-lg p-4 text-center">
                                <div class="text-2xl font-bold">$<span id="totalSales">0</span></div>
                                <div class="text-sm opacity-90">Ventas Totales</div>
                            </div>
                            
                            <div class="stats-card rounded-lg p-4 text-center">
                                <div class="text-2xl font-bold">$<span id="netProfit">0</span></div>
                                <div class="text-sm opacity-90">Ganancia Neta</div>
                            </div>
                            
                            <div class="stats-card rounded-lg p-4 text-center">
                                <div class="text-2xl font-bold"><span id="lowStockProducts">0</span></div>
                                <div class="text-sm opacity-90">Productos con Bajo Stock</div>
                            </div>
                             <div class="stats-card rounded-lg p-4 text-center col-span-1 sm:col-span-2">
                                <div class="text-2xl font-bold">$<span id="totalRestockAmount">0</span></div>
                                <div class="text-sm opacity-90">Monto Total a Reponer</div>
                            </div>
                        </div>
                    </div>
                    
                    <div class="bg-white rounded-xl shadow-lg p-6">
                        <h3 class="text-lg font-semibold mb-4">Desglose de Monto a Reponer por Categoría</h3>
                        <div id="restockByCategoryList" class="space-y-2">
                            <div class="text-gray-500 text-center py-2">No hay datos de reposición disponibles.</div>
                        </div>
                    </div>

                    <div class="bg-white rounded-xl shadow-lg p-6">
                        <h3 class="text-lg font-semibold mb-4">Productos con Bajo Stock (≤ 5)</h3>
                        <div id="lowStockList" class="space-y-2">
                            <div class="text-gray-500 text-center py-2">No hay productos con bajo stock.</div>
                        </div>
                    </div>
                </div>
                
                <div class="space-y-6">
                    <div class="bg-white rounded-xl shadow-lg p-6">
                        <h3 class="text-lg font-semibold mb-4">Ventas por Día (Últimos 7 días)</h3>
                        <div id="dailySalesChart" class="h-64 flex justify-around items-end">
                            <div class="text-gray-500 text-center py-4">Cargando gráfico...</div>
                        </div>
                    </div>
                    
                    <div class="bg-white rounded-xl shadow-lg p-6">
                        <h3 class="text-lg font-semibold mb-4">Historial de Ventas Hoy</h3>
                        <div id="todaySales" class="space-y-2 max-h-64 overflow-y-auto">
                            <div class="text-gray-500 text-center py-4">No hay ventas registradas hoy</div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script type="module">
        // Importar funciones de Firebase SDK v10.x.x
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.10.0/firebase-app.js";
        import { getFirestore, collection, getDocs, addDoc, updateDoc, deleteDoc, doc, query, orderBy, Timestamp } from "https://www.gstatic.com/firebasejs/11.10.0/firebase-firestore.js";
        // getAnalytics es opcional si no lo estás usando activamente
        // import { getAnalytics } from "https://www.gstatic.com/firebasejs/11.10.0/firebase-analytics.js";

        // TU CONFIGURACIÓN DE FIREBASE (¡MANTENLA PRIVADA!)
        // Esta es la configuración que tenías anteriormente, si la cambiaste, actualízala aquí.
        const firebaseConfig = {
            apiKey: "AIzaSyBq23VYwgl2xVw2Vukbbz0NDHtc0cFH-PI",
            authDomain: "elpobladorestobar-5d2f4.firebaseapp.com",
            projectId: "elpobladorestobar-5d2f4",
            storageBucket: "elpobladorestobar-5d2f4.firebasestorage.app",
            messagingSenderId: "382944057692",
            appId: "1:382944057692:web:00a1131e5e79ba31588999",
            measurementId: "G-CPDKVHRM48"
        };

        // Inicializar Firebase
        const app = initializeApp(firebaseConfig);
        const db = getFirestore(app);
        // const analytics = getAnalytics(app); // Si no usas analytics, puedes comentarlo o quitarlo

        // Variables globales
        let products = []; // Se cargarán desde Firebase
        let cart = [];
        let sales = []; // Se cargarán desde Firebase
        let dailySales = {}; // Se calculará de las ventas cargadas o nuevas

        // --- Funciones de interacción con Firebase ---

        // Fetch (obtener) productos desde Firestore
        async function fetchProducts() {
            try {
                const productosCol = collection(db, 'productos'); // Nombre de colección en español
                const productosSnapshot = await getDocs(productosCol);
                products = productosSnapshot.docs.map(doc => ({
                    id: doc.id, // ID del documento de Firestore
                    ...doc.data()
                }));
                console.log("Productos cargados de Firebase:", products);
                loadProducts(); // Recargar la UI con los productos de Firebase
                loadInventoryTable(); // Recargar la tabla de inventario
                updateSummaryStats(); // Para que el resumen de bajo stock se actualice
            } catch (error) {
                console.error("Error al cargar productos de Firestore:", error);
                //alert("Error al cargar productos: " + error.message); // Comentar para evitar muchos alerts durante el desarrollo
            }
        }

        // Fetch (obtener) ventas desde Firestore
        async function fetchSales() {
            try {
                const ventasCol = collection(db, 'ventas'); // Nombre de colección en español
                // Opcional: ordenar las ventas por timestamp
                const q = query(ventasCol, orderBy('timestamp', 'desc')); 
                const ventasSnapshot = await getDocs(q);
                sales = ventasSnapshot.docs.map(doc => {
                    const data = doc.data();
                    // Asegúrate de convertir el Timestamp de Firestore a objeto Date
                    return {
                        id: doc.id,
                        ...data,
                        timestamp: data.timestamp instanceof Timestamp ? data.timestamp.toDate() : new Date(data.timestamp) // Manejar Timestamp o String
                    };
                });
                console.log("Ventas cargadas de Firebase:", sales);
                updateDailySalesFromLoadedSales(); // Actualizar dailySales basado en las ventas cargadas
                updateSummaryStats(); // Recargar la UI de resumen
                loadDailySalesChart(); // Recargar el gráfico
                loadTodaySales(); // Recargar las ventas de hoy
            } catch (error) {
                console.error("Error al cargar ventas de Firestore:", error);
                //alert("Error al cargar ventas: " + error.message); // Comentar para evitar muchos alerts durante el desarrollo
            }
        }

        // Agregar producto a Firestore
        async function addProductToFirestore(newProductData) {
            try {
                const productosCol = collection(db, 'productos'); // Nombre de colección en español
                const docRef = await addDoc(productosCol, newProductData);
                console.log("Producto agregado con ID:", docRef.id);
                // Volver a cargar productos para actualizar la UI con el nuevo producto y su ID de Firestore
                await fetchProducts(); 
                alert('Producto agregado exitosamente');
            } catch (error) {
                console.error("Error al agregar producto a Firestore:", error);
                alert("Error al agregar producto: " + error.message);
            }
        }

        // Actualizar producto en Firestore
        async function updateProductInFirestore(productId, field, value) {
            try {
                const productRef = doc(db, 'productos', productId); // Nombre de colección en español
                const updateData = { [field]: value };
                
                // Si el campo es 'price', también actualiza el 'cost'
                if (field === 'price') {
                    updateData.cost = value * 0.6; // O tu lógica de cálculo de costo
                }
                 // Si el campo es 'cost', simplemente actualiza el costo
                if (field === 'cost') {
                    updateData.cost = value;
                }
                
                await updateDoc(productRef, updateData);
                console.log(`Producto ${productId} actualizado en Firestore: ${field} = ${value}`);
                // Después de actualizar, recargamos solo la tabla de inventario para reflejar cambios de stock visualmente
                // loadInventoryTable(); // Esto ya se llama desde updateProduct si el campo es 'stock'
            } catch (error) {
                console.error("Error al actualizar producto en Firestore:", error);
                alert("Error al actualizar producto: " + error.message);
            }
        }

        // Eliminar producto de Firestore
        async function deleteProductFromFirestore(productId) {
            try {
                const productRef = doc(db, 'productos', productId); // Nombre de colección en español
                await deleteDoc(productRef);
                console.log(`Producto ${productId} eliminado de Firestore.`);
                await fetchProducts(); // Recargar productos para actualizar la UI
                alert('Producto eliminado exitosamente');
            } catch (error) {
                console.error("Error al eliminar producto de Firestore:", error);
                alert("Error al eliminar producto: " + error.message);
            }
        }

        // Agregar venta a Firestore
        async function addSaleToFirestore(saleData) {
            try {
                const ventasCol = collection(db, 'ventas'); // Nombre de colección en español
                // Firebase Timestamp es el formato recomendado para fechas en Firestore
                const docRef = await addDoc(ventasCol, {
                    ...saleData,
                    timestamp: Timestamp.fromDate(saleData.timestamp) 
                });
                console.log("Venta agregada con ID:", docRef.id);
                // Volver a cargar ventas para actualizar la UI de resumen
                await fetchSales();
            } catch (error) {
                console.error("Error al agregar venta a Firestore:", error);
                alert("Error al procesar venta: " + error.message);
            }
        }
        
        // --- Funciones de la UI (adaptadas para usar Firebase) ---

        // Función para mostrar/ocultar tabs
        function showTab(tabName) {
            // Ocultar todos los tabs
            document.querySelectorAll('.tab-content').forEach(tab => {
                tab.classList.add('hidden');
            });
            
            // Remover clase active de todos los botones
            document.querySelectorAll('.tab-button').forEach(btn => {
                btn.classList.remove('active');
            });
            
            // Mostrar tab seleccionado
            document.getElementById(tabName + '-tab').classList.remove('hidden');
            
            // Marcar botón como activo
            document.querySelector(`.tab-button[onclick="window.showTab('${tabName}')"]`).classList.add('active');
            
            // Actualizar contenido según el tab
            if (tabName === 'ventas') {
                loadProducts(); 
                updateCart();
            } else if (tabName === 'inventario') {
                loadInventoryTable();
            } else if (tabName === 'resumen') {
                updateSummaryStats();
                loadDailySalesChart();
                loadTodaySales();
            }
        }
        
        // Función para cargar productos en la interfaz de ventas
        function loadProducts() {
            const productList = document.getElementById('productList');
            const categoryFilter = document.getElementById('categoryFilter');
            const selectedCategory = categoryFilter.value;
            
            // Actualizar opciones de categoría (asegurarse de que las categorías de Firebase se reflejen)
            const categories = [...new Set(products.map(p => p.category).filter(Boolean))].sort(); // Solo categorías existentes, y ordenar
            categoryFilter.innerHTML = '<option value="">Todas las categorías</option>';
            categories.forEach(cat => {
                const option = document.createElement('option');
                option.value = cat;
                option.textContent = cat;
                categoryFilter.appendChild(option);
            });
            categoryFilter.value = selectedCategory; 
            
            // Filtrar productos
            const filteredProducts = selectedCategory ? 
                products.filter(p => p.category === selectedCategory) : 
                products;
            
            productList.innerHTML = '';
            if (filteredProducts.length === 0) {
                productList.innerHTML = '<p class="text-gray-500 text-center col-span-full">No hay productos disponibles. Agrega algunos desde la pestaña de Inventario.</p>';
                return;
            }

            filteredProducts.forEach(product => {
                const productCard = document.createElement('div');
                productCard.className = 'product-card rounded-lg p-4 cursor-pointer';
                
                const stockStatus = product.stock <= 5 ? 'text-red-600 font-semibold' : 
                                  product.stock <= 10 ? 'text-yellow-600 font-semibold' : 
                                  'text-green-600';
                
                productCard.innerHTML = `
                    <div class="flex justify-between items-start mb-2">
                        <h3 class="font-semibold text-gray-800">${product.name}</h3>
                        <span class="category-badge text-white text-xs px-2 py-1 rounded-full">${product.category || 'Sin Categoría'}</span>
                    </div>
                    <div class="text-lg font-bold text-blue-600 mb-1">$${product.price ? product.price.toFixed(2) : '0.00'}</div>
                    <div class="${stockStatus}">Stock: ${product.stock || 0}</div>
                `;
                
                if (product.stock > 0) {
                    productCard.onclick = () => window.addToCart(product.id);
                } else {
                    productCard.style.opacity = '0.5';
                    productCard.style.cursor = 'not-allowed';
                }
                
                productList.appendChild(productCard);
            });
        }
        
        // Función para agregar al carrito
        function addToCart(productId) {
            const product = products.find(p => p.id === productId);
            if (!product || product.stock <= 0) {
                alert('Producto agotado o no encontrado.');
                return;
            }
            
            const existingItem = cart.find(item => item.id === productId);
            
            if (existingItem) {
                if (existingItem.quantity < product.stock) {
                    existingItem.quantity++;
                } else {
                    alert('No hay suficiente stock para añadir más de este producto.');
                }
            } else {
                cart.push({
                    id: product.id,
                    name: product.name,
                    price: product.price,
                    quantity: 1,
                    cost: product.cost || (product.price * 0.6) // Asegurar que el costo esté presente
                });
            }
            
            updateCart();
        }
        
        // Función para actualizar carrito
        function updateCart() {
            const cartElement = document.getElementById('cart');
            const totalElement = document.getElementById('totalAmount');
            const receivedInput = document.getElementById('receivedAmount');
            const changeElement = document.getElementById('changeAmount');
            
            cartElement.innerHTML = '';
            let total = 0;
            
            if (cart.length === 0) {
                cartElement.innerHTML = '<p class="text-gray-500 text-center py-4">El carrito está vacío.</p>';
            }

            cart.forEach(item => {
                const productInStock = products.find(p => p.id === item.id);
                // Si el producto ya no existe en el inventario principal (ej. fue borrado)
                // lo mantenemos en el carrito pero no permitimos aumentar stock
                const currentStock = productInStock ? productInStock.stock : 0; 

                const cartItem = document.createElement('div');
                cartItem.className = 'cart-item rounded-lg p-3';
                
                cartItem.innerHTML = `
                    <div class="flex justify-between items-center">
                        <div class="flex-1">
                            <div class="font-semibold">${item.name}</div>
                            <div class="text-sm text-gray-600">$${item.price ? item.price.toFixed(2) : '0.00'} x ${item.quantity}</div>
                        </div>
                        <div class="flex items-center gap-2">
                            <button onclick="window.changeQuantity('${item.id}', -1)" class="w-6 h-6 bg-gray-300 rounded text-center text-sm hover:bg-gray-400 transition-all">-</button>
                            <span class="font-semibold">${item.quantity}</span>
                            <button onclick="window.changeQuantity('${item.id}', 1)" class="w-6 h-6 bg-gray-300 rounded text-center text-sm hover:bg-gray-400 transition-all"${item.quantity >= currentStock ? ' disabled' : ''}>+</button>
                            <button onclick="window.removeFromCart('${item.id}')" class="w-6 h-6 bg-red-500 text-white rounded text-center text-sm hover:bg-red-600 transition-all">×</button>
                        </div>
                    </div>
                    <div class="text-right font-bold mt-2">$${(item.price * item.quantity).toFixed(2)}</div>
                `;
                
                cartElement.appendChild(cartItem);
                total += item.price * item.quantity;
            });
            
            totalElement.textContent = total.toFixed(2);
            
            const received = parseFloat(receivedInput.value) || 0;
            const change = Math.max(0, received - total);
            changeElement.textContent = change.toFixed(2);
        }
        
        // Función para cambiar cantidad
        async function changeQuantity(productId, delta) {
            const itemIndex = cart.findIndex(item => item.id === productId);
            if (itemIndex === -1) return;

            const item = cart[itemIndex];
            const product = products.find(p => p.id === productId);
            
            if (!product) { // Si el producto no se encuentra en el inventario (fue borrado, etc.)
                if (item.quantity + delta <= 0) {
                     window.removeFromCart(productId);
                } else {
                    alert('Este producto ya no está en el inventario y no se puede modificar su cantidad.');
                }
                return;
            } 
            
            const newQuantity = item.quantity + delta;
            
            if (newQuantity <= 0) {
                window.removeFromCart(productId); 
            } else if (newQuantity <= product.stock) {
                item.quantity = newQuantity;
            } else {
                alert('No hay suficiente stock disponible.');
            }
            
            updateCart();
        }
        
        // Función para remover del carrito
        function removeFromCart(productId) {
            cart = cart.filter(item => item.id !== productId);
            updateCart();
        }
        
        // Función para limpiar carrito
        function clearCart() {
            cart = [];
            document.getElementById('receivedAmount').value = '';
            updateCart();
        }
        
        // Función para procesar venta
        async function processSale() {
            if (cart.length === 0) {
                alert('El carrito está vacío');
                return;
            }
            
            const total = cart.reduce((sum, item) => sum + (item.price * item.quantity), 0);
            const received = parseFloat(document.getElementById('receivedAmount').value) || 0;
            
            if (received < total) {
                alert('El dinero recibido es insuficiente');
                return;
            }
            
            const sale = {
                timestamp: new Date(), 
                items: cart.map(item => ({
                    id: item.id,
                    name: item.name,
                    price: item.price,
                    quantity: item.quantity,
                    cost: item.cost // Usar el costo que viene del producto
                })),
                total: total,
                received: received,
                change: received - total
            };
            
            for (const item of cart) {
                const product = products.find(p => p.id === item.id);
                if (product) {
                    const newStock = product.stock - item.quantity;
                    if (newStock < 0) {
                        alert(`Error: Stock insuficiente para ${product.name}`);
                        return; 
                    }
                    await updateProductInFirestore(product.id, 'stock', newStock);
                } else {
                    console.warn(`Producto con ID ${item.id} no encontrado en el inventario. No se actualizó el stock.`);
                }
            }

            await addSaleToFirestore(sale);
            
            alert(`Venta procesada exitosamente!\nTotal: $${total.toFixed(2)}\nCambio: $${(received - total).toFixed(2)}`);
            
            clearCart();
            await fetchProducts(); // Refrescar productos y UI de ventas/inventario
        }
        
        // Función para mostrar formulario de agregar producto
        function showAddProductForm() {
            document.getElementById('addProductForm').classList.remove('hidden');
        }
        
        // Función para ocultar formulario de agregar producto
        function hideAddProductForm() {
            document.getElementById('addProductForm').classList.add('hidden');
            document.getElementById('newProductName').value = '';
            document.getElementById('newProductPrice').value = '';
            document.getElementById('newProductStock').value = '';
            document.getElementById('newProductCategory').value = '';
            document.getElementById('newProductCost').value = '';
        }
        
        // Función para agregar producto (llama a la función de Firebase)
        async function addProduct() {
            const name = document.getElementById('newProductName').value.trim();
            const price = parseFloat(document.getElementById('newProductPrice').value);
            const stock = parseInt(document.getElementById('newProductStock').value);
            const category = document.getElementById('newProductCategory').value.trim();
            const costInput = document.getElementById('newProductCost').value;
            const cost = costInput ? parseFloat(costInput) : price * 0.6; // Si no se especifica, calcula 60% del precio
            
            if (!name || isNaN(price) || isNaN(stock) || !category) {
                alert('Por favor complete los campos obligatorios (Nombre, Precio, Stock, Categoría) con valores válidos');
                return;
            }
            if (isNaN(cost)) {
                 alert('Por favor ingrese un valor válido para el Costo.');
                 return;
            }
            
            const newProductData = {
                name: name,
                price: price,
                stock: stock,
                category: category,
                cost: cost 
            };
            
            await addProductToFirestore(newProductData);
            hideAddProductForm();
        }
        
        // Función para cargar tabla de inventario
        function loadInventoryTable() {
            const tableBody = document.getElementById('inventoryTable');
            tableBody.innerHTML = '';
            
            if (products.length === 0) {
                tableBody.innerHTML = '<tr><td colspan="6" class="text-center py-4 text-gray-500">No hay productos en el inventario.</td></tr>';
                return;
            }

            products.forEach(product => {
                const row = document.createElement('tr');
                row.className = 'hover:bg-gray-50 transition-all';
                
                const stockClass = product.stock <= 5 ? 'text-red-600 font-semibold' :
                                  product.stock <= 10 ? 'text-yellow-600 font-semibold' :
                                  'text-green-600';
                
                row.innerHTML = `
                    <td class="border border-gray-200 px-4 py-3">
                        <input type="text" value="${product.name || ''}" onchange="window.updateProduct('${product.id}', 'name', this.value)" 
                               class="w-full border-none bg-transparent focus:bg-white focus:border focus:border-blue-300 rounded px-2 py-1">
                    </td>
                    <td class="border border-gray-200 px-4 py-3">
                        <input type="number" value="${product.price || 0}" step="0.01" onchange="window.updateProduct('${product.id}', 'price', parseFloat(this.value))" 
                               class="w-full border-none bg-transparent focus:bg-white focus:border focus:border-blue-300 rounded px-2 py-1">
                    </td>
                    <td class="border border-gray-200 px-4 py-3 ${stockClass}">
                        <input type="number" value="${product.stock || 0}" onchange="window.updateProduct('${product.id}', 'stock', parseInt(this.value))" 
                               class="w-full border-none bg-transparent focus:bg-white focus:border focus:border-blue-300 rounded px-2 py-1">
                    </td>
                    <td class="border border-gray-200 px-4 py-3">
                        <input type="text" value="${product.category || ''}" onchange="window.updateProduct('${product.id}', 'category', this.value)" 
                               class="w-full border-none bg-transparent focus:bg-white focus:border focus:border-blue-300 rounded px-2 py-1">
                    </td>
                     <td class="border border-gray-200 px-4 py-3">
                        <input type="number" value="${product.cost || 0}" step="0.01" onchange="window.updateProduct('${product.id}', 'cost', parseFloat(this.value))" 
                               class="w-full border-none bg-transparent focus:bg-white focus:border focus:border-blue-300 rounded px-2 py-1">
                    </td>
                    <td class="border border-gray-200 px-4 py-3">
                        <button onclick="window.deleteProduct('${product.id}')" class="btn-danger px-3 py-1 text-white text-sm rounded hover:opacity-80 transition-all">
                            Eliminar
                        </button>
                    </td>
                `;
                
                tableBody.appendChild(row);
            });
        }
        
        // Función para actualizar producto (actualiza local y llama a Firebase)
        async function updateProduct(productId, field, value) {
            const productIndex = products.findIndex(p => p.id === productId);
            if (productIndex !== -1) {
                products[productIndex][field] = value;
                if (field === 'price') {
                    // Recalcula el costo si el precio cambia, a menos que el costo sea editado manualmente
                    // Mantener la proporción de 0.6 o permitir la edición manual del costo
                    if (!products[productIndex].cost || products[productIndex].cost === products[productIndex].price * 0.6) {
                        products[productIndex].cost = value * 0.6; // Si el costo no ha sido modificado, actualiza basado en el precio
                        await updateProductInFirestore(productId, 'cost', products[productIndex].cost);
                    }
                }
                await updateProductInFirestore(productId, field, value);
                if (field === 'stock' || field === 'name' || field === 'price' || field === 'category' || field === 'cost') {
                    // Vuelve a cargar productos para asegurar que las vistas de "ventas" y "resumen" también se actualicen
                    await fetchProducts(); 
                }
            }
        }
        
        // Función para eliminar producto (elimina local y llama a Firebase)
        async function deleteProduct(productId) {
            if (confirm('¿Está seguro de eliminar este producto? Esta acción es irreversible.')) {
                await deleteProductFromFirestore(productId);
            }
        }

        // Función para actualizar `dailySales` a partir de las `sales` cargadas de Firebase
        function updateDailySalesFromLoadedSales() {
            dailySales = {}; 
            sales.forEach(sale => {
                const saleDate = sale.timestamp.toDateString(); 
                if (!dailySales[saleDate]) {
                    dailySales[saleDate] = 0;
                }
                dailySales[saleDate] += sale.total;
            });
            console.log("Ventas diarias actualizadas:", dailySales);
        }
        
        // Función para actualizar estadísticas de resumen
        function updateSummaryStats() {
            const totalSales = sales.reduce((sum, sale) => sum + sale.total, 0);
            
            let totalCost = 0;
            let restockCategories = {
                'Cerveza': 0,
                'Old Times': 0,
                '220V': 0,
                'Otros': 0 
            };

            sales.forEach(sale => {
                sale.items.forEach(item => {
                    const productCost = item.cost || (products.find(p => p.id === item.id)?.cost || 0); // Usa el costo guardado en la venta o búscalo
                    if (productCost) {
                        const itemCost = productCost * item.quantity;
                        totalCost += itemCost;

                        const productNameLower = item.name ? item.name.toLowerCase() : ''; 
                        
                        if (productNameLower.includes('cerveza')) {
                            restockCategories['Cerveza'] += itemCost;
                        } else if (productNameLower.includes('old times')) {
                            restockCategories['Old Times'] += itemCost;
                        } else if (productNameLower.includes('220v')) {
                            restockCategories['220V'] += itemCost;
                        } else {
                            restockCategories['Otros'] += itemCost;
                        }
                    }
                });
            });

            const netProfit = totalSales - totalCost; 
            const restockAmount = totalCost; 
            
            document.getElementById('totalSales').textContent = totalSales.toFixed(2);
            document.getElementById('netProfit').textContent = netProfit.toFixed(2);
            document.getElementById('totalRestockAmount').textContent = restockAmount.toFixed(2); 
            
            const lowStockProducts = products.filter(p => p.stock !== undefined && p.stock <= 5); // Asegura que stock exista
            document.getElementById('lowStockProducts').textContent = lowStockProducts.length;
            
            const lowStockList = document.getElementById('lowStockList');
            lowStockList.innerHTML = '';
            
            if (lowStockProducts.length === 0) {
                lowStockList.innerHTML = '<div class="text-green-600 font-semibold">Todos los productos tienen stock suficiente</div>';
            } else {
                lowStockProducts.forEach(product => {
                    const item = document.createElement('div');
                    item.className = 'bg-red-50 border border-red-200 rounded-lg p-3';
                    item.innerHTML = `
                        <div class="font-semibold text-red-800">${product.name}</div>
                        <div class="text-sm text-red-600">Stock actual: ${product.stock} unidades</div>
                        <div class="text-sm text-red-600">Costo de reposición: $${(product.cost || 0.00).toFixed(2)}</div>
                    `;
                    lowStockList.appendChild(item);
                });
            }

            const restockByCategoryList = document.getElementById('restockByCategoryList');
            restockByCategoryList.innerHTML = ''; 
            
            const hasRestockData = Object.values(restockCategories).some(value => value > 0);

            if (!hasRestockData) {
                restockByCategoryList.innerHTML = '<div class="text-gray-500 text-center py-2">No hay datos de reposición disponibles.</div>';
            } else {
                 for (const category in restockCategories) {
                    if (restockCategories[category] > 0) { // Solo mostrar categorías con monto > 0
                        const categoryItem = document.createElement('div');
                        categoryItem.className = 'bg-blue-50 border border-blue-200 rounded-lg p-3 flex justify-between items-center';
                        categoryItem.innerHTML = `
                            <div class="font-semibold text-blue-800">${category}</div>
                            <div class="font-bold text-blue-600">$${restockCategories[category].toFixed(2)}</div>
                        `;
                        restockByCategoryList.appendChild(categoryItem);
                    }
                }
            }
        }
        
        // Función para cargar gráfico de ventas diarias
        function loadDailySalesChart() {
            const chartContainer = document.getElementById('dailySalesChart');
            chartContainer.innerHTML = ''; // Limpiar el contenido previo
            
            const days = [];
            const values = [];
            
            for (let i = 6; i >= 0; i--) {
                const date = new Date();
                date.setDate(date.getDate() - i);
                const dateKey = date.toDateString();
                
                days.push(date.toLocaleDateString('es', { day: 'numeric', month: 'short' })); // Formato más compacto
                values.push(dailySales[dateKey] || 0);
            }
            
            const maxValue = Math.max(...values, 100); // Asegurarse de que el valor máximo sea al menos 100 para evitar barras invisibles
            
            const chartHTML = days.map((day, index) => {
                const height = (values[index] / maxValue) * 100;
                return `
                    <div class="flex flex-col items-center flex-1 mx-1">
                        <div class="w-8 bg-gray-200 rounded" style="height: 180px; display: flex; align-items: flex-end;">
                            <div class="chart-bar w-full bg-gradient-to-t from-blue-500 to-purple-600 rounded" style="height: ${height}%; min-height: 4px;"></div>
                        </div>
                        <div class="text-xs mt-2 text-center">${day}</div>
                        <div class="text-xs font-semibold text-gray-600">$${values[index].toFixed(0)}</div>
                    </div>
                `;
            }).join('');
            
            chartContainer.innerHTML = `
                <div class="flex justify-around items-end h-full w-full">
                    ${chartHTML}
                </div>
            `;
        }
        
        // Función para cargar ventas de hoy
        function loadTodaySales() {
            const todaySalesContainer = document.getElementById('todaySales');
            const today = new Date().toDateString();
            const todaySales = sales.filter(sale => sale.timestamp.toDateString() === today);
            
            todaySalesContainer.innerHTML = '';
            
            if (todaySales.length === 0) {
                todaySalesContainer.innerHTML = '<div class="text-gray-500 text-center py-4">No hay ventas registradas hoy</div>';
                return;
            }
            
            todaySales.sort((a, b) => b.timestamp.getTime() - a.timestamp.getTime()); 
            
            todaySales.forEach(sale => {
                const saleItem = document.createElement('div');
                saleItem.className = 'bg-gray-50 rounded-lg p-3 border';
                
                const itemsList = sale.items.map(item => `${item.name} x${item.quantity}`).join(', ');
                
                saleItem.innerHTML = `
                    <div class="flex justify-between items-start">
                        <div class="flex-1">
                            <div class="text-sm font-semibold">${sale.timestamp.toLocaleTimeString('es-ES', {hour: '2-digit', minute:'2-digit'})}</div>
                            <div class="text-sm text-gray-600">${itemsList}</div>
                        </div>
                        <div class="text-right">
                            <div class="font-semibold text-green-600">$${sale.total.toFixed(2)}</div>
                            <div class="text-xs text-gray-500">${sale.items.length} productos</div>
                        </div>
                    </div>
                `;
                
                todaySalesContainer.appendChild(saleItem);
            });
        }
        
        // Event listeners
        document.getElementById('categoryFilter').addEventListener('change', loadProducts);
        document.getElementById('receivedAmount').addEventListener('input', updateCart);
        
        // Hacer las funciones globales para que puedan ser llamadas desde onclick en el HTML
        window.showTab = showTab;
        window.addToCart = addToCart;
        window.changeQuantity = changeQuantity;
        window.removeFromCart = removeFromCart;
        window.clearCart = clearCart;
        window.processSale = processSale;
        window.showAddProductForm = showAddProductForm;
        window.hideAddProductForm = hideAddProductForm;
        window.addProduct = addProduct;
        window.updateProduct = updateProduct;
        window.deleteProduct = deleteProduct;


        // Inicialización - Cargar datos al iniciar y mostrar el tab de ventas
        document.addEventListener('DOMContentLoaded', async function() {
            // Cargar datos de Firebase al iniciar la aplicación
            await fetchProducts(); 
            await fetchSales(); 

            // Establecer el tab "Ventas" como activo al cargar la página
            const firstTabButton = document.querySelector('.tab-button');
            if (firstTabButton) {
                firstTabButton.classList.add('active');
                window.showTab('ventas'); 
            }
        });
    </script>
</body>
</html>
